<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ecommerce Analytics Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #181826;
    --border: #252535;
    --accent: #7c6cfc;
    --accent2: #fc6cc8;
    --accent3: #6cfcb8;
    --accent4: #fcb86c;
    --text: #e8e8f0;
    --muted: #888899;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; min-height: 100vh; line-height: 1.5; }

  /* ‚îÄ‚îÄ UPLOAD BAR ‚îÄ‚îÄ */
  .upload-bar {
    background: linear-gradient(135deg, #0d0d1a 0%, #12121e 100%);
    border-bottom: 1px solid var(--border);
    padding: 16px 40px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .upload-row {
    display: flex;
    align-items: center;
    gap: 14px;
    flex-wrap: wrap;
  }
  .upload-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--muted);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .file-drop {
    flex: 1;
    min-width: 240px;
    border: 1.5px dashed var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--muted);
    font-size: 12px;
    position: relative;
    overflow: hidden;
    background: var(--surface);
  }
  .file-drop:hover, .file-drop.drag-over {
    border-color: var(--accent);
    color: var(--text);
    background: rgba(124,108,252,0.07);
    box-shadow: 0 0 0 3px rgba(124,108,252,0.08);
  }
  .file-drop input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
    font-size: 0;
  }
  .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
  .btn-load {
    padding: 10px 22px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 7px;
    flex-shrink: 0;
  }
  .btn-load:hover:not(:disabled) { background: #9180fc; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124,108,252,0.3); }
  .btn-load:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
  .upload-status {
    font-size: 11px;
    padding: 5px 13px;
    border-radius: 6px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .status-ok      { background: rgba(108,252,184,0.1); color: var(--accent3); border: 1px solid rgba(108,252,184,0.2); }
  .status-err     { background: rgba(252,108,200,0.1); color: var(--accent2); border: 1px solid rgba(252,108,200,0.2); }
  .status-loading { background: rgba(124,108,252,0.1); color: var(--accent);  border: 1px solid rgba(124,108,252,0.2); }
  .formats { font-size: 10px; color: #444460; letter-spacing: 0.5px; margin-left: auto; flex-shrink: 0; }

  /* column mapper */
  .col-map-row {
    display: none;
    padding: 12px 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    gap: 10px 14px;
    flex-wrap: wrap;
    align-items: center;
  }
  .col-map-row.visible { display: flex; }
  .map-lbl { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .col-select {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 5px;
    padding: 4px 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    min-width: 120px;
  }
  .col-select:focus { outline: none; border-color: var(--accent); }
  .btn-apply {
    padding: 6px 16px;
    background: var(--accent3);
    color: #0a0a0f;
    border: none;
    border-radius: 6px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    margin-left: auto;
  }
  .btn-apply:hover { background: #8dffd4; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    padding: 26px 40px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    background: linear-gradient(135deg, #0a0a0f 0%, #111128 100%);
    flex-wrap: wrap;
    gap: 14px;
  }
  .header-left h1 {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -1px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 60%, var(--accent4) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
    margin-bottom: 5px;
  }
  .header-left p { color: var(--muted); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; }
  .filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .filter-btn {
    padding: 6px 14px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    border-radius: 6px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .filter-btn:hover { border-color: var(--accent); color: var(--text); background: rgba(124,108,252,0.08); }
  .filter-btn.active { background: rgba(124,108,252,0.15); color: var(--accent); border-color: var(--accent); }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 70px 40px;
    gap: 14px;
    color: var(--muted);
    text-align: center;
  }
  .empty-arrow { font-size: 26px; animation: bounce 1.5s ease-in-out infinite; }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  .empty-icon { font-size: 50px; opacity: 0.35; }
  .empty-state h2 { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; color: var(--text); }
  .empty-state p { font-size: 12px; max-width: 360px; line-height: 1.8; }
  .hint-cols {
    font-size: 10px;
    color: #363650;
    margin-top: 8px;
    padding: 10px 16px;
    border: 1px dashed #252535;
    border-radius: 8px;
    line-height: 2;
  }

  /* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
  .dashboard { padding: 22px 40px; }
  .kpi-row { display: grid; grid-template-columns: repeat(5,1fr); gap: 14px; margin-bottom: 18px; }
  .kpi {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
  }
  .kpi::before { content:''; position:absolute; top:0;left:0;right:0; height:2px; background:var(--kpi-color,var(--accent)); }
  .kpi:hover { border-color: var(--accent); transform: translateY(-1px); }
  .kpi-label { color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
  .kpi-value { font-family:'Syne',sans-serif; font-size:22px; font-weight:700; line-height:1; margin-bottom:5px; }
  .kpi-sub { color:var(--muted); font-size:10px; }
  .kpi-badge { display:inline-block; padding:2px 7px; border-radius:4px; font-size:10px; font-weight:500; margin-left:4px; }
  .badge-up   { background:rgba(108,252,184,0.15); color:var(--accent3); }
  .badge-down { background:rgba(252,108,200,0.15); color:var(--accent2); }
  .charts-grid  { display:grid; grid-template-columns:2fr 1fr; gap:14px; margin-bottom:14px; }
  .charts-grid2 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; margin-bottom:14px; }
  .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; }
  .card-title { font-family:'Syne',sans-serif; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:16px; display:flex; align-items:center; justify-content:space-between; }
  .card-title span { color:var(--text); font-size:11px; font-weight:400; font-family:'DM Mono',monospace; text-transform:none; letter-spacing:0; }
  .chart-container { position:relative; }
  .table-wrap { overflow:auto; max-height:300px; }
  table { width:100%; border-collapse:collapse; }
  thead th { position:sticky; top:0; background:var(--surface2); color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; padding:9px 12px; text-align:left; border-bottom:1px solid var(--border); white-space:nowrap; }
  tbody tr { border-bottom:1px solid var(--border); transition:background 0.15s; }
  tbody tr:hover { background:var(--surface2); }
  tbody td { padding:9px 12px; color:var(--text); font-size:12px; white-space:nowrap; }
  .dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:5px; flex-shrink:0; }
  .legend-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
  .legend-item { display:flex; align-items:center; font-size:11px; color:var(--muted); gap:4px; }
  .bar-track { background:var(--surface2); border-radius:4px; height:6px; flex:1; min-width:60px; }
  .bar-fill { height:6px; border-radius:4px; transition:width 0.5s ease; }
  .platform-row { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
  .platform-row:last-child { border-bottom:none; }
  .platform-name { width:100px; font-size:12px; display:flex; align-items:center; }
  .platform-val { width:70px; text-align:right; font-family:'Syne',sans-serif; font-size:13px; font-weight:600; }
  .returns-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  .return-stat { background:var(--surface2); border-radius:8px; padding:12px; text-align:center; }
  .return-stat .val { font-family:'Syne',sans-serif; font-size:20px; font-weight:700; margin-bottom:4px; }
  .return-stat .lbl { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }

  @media (max-width:960px) {
    .kpi-row { grid-template-columns:repeat(3,1fr); }
    .charts-grid,.charts-grid2 { grid-template-columns:1fr; }
    .upload-bar,.header,.dashboard { padding-left:20px; padding-right:20px; }
  }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ UPLOAD BAR ‚îÄ‚îÄ -->
<div class="upload-bar">
  <div class="upload-row">
    <div class="upload-label">üìä Data Source</div>

    <div class="file-drop" id="fileDrop"
         ondragover="onDragOver(event)"
         ondragleave="onDragLeave(event)"
         ondrop="onDrop(event)">
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="onFileChange(event)">
      <span style="font-size:18px;flex-shrink:0">üìÇ</span>
      <span class="file-name" id="fileLabel">Click to browse  or  drag &amp; drop your Excel / CSV file here</span>
    </div>

    <button class="btn-load" id="loadBtn" onclick="processFile()" disabled>
      ‚ñ∂ Load Data
    </button>

    <div id="statusBadge"></div>
    <div class="formats">.xlsx ¬∑ .xls ¬∑ .csv</div>
  </div>

  <!-- Column mapper ‚Äî shown when auto-detection fails -->
  <div class="col-map-row" id="colMapRow">
    <span class="map-lbl">Map columns ‚Üí</span>
    <span class="map-lbl">Vendor:</span>    <select class="col-select" id="mapVendor"></select>
    <span class="map-lbl">Platform:</span>  <select class="col-select" id="mapPlatform"></select>
    <span class="map-lbl">Month:</span>     <select class="col-select" id="mapMonth"></select>
    <span class="map-lbl">Product:</span>   <select class="col-select" id="mapProduct"></select>
    <span class="map-lbl">Qty:</span>       <select class="col-select" id="mapQty"></select>
    <span class="map-lbl">MRP:</span>       <select class="col-select" id="mapMrp"></select>
    <span class="map-lbl">Value/Revenue:</span> <select class="col-select" id="mapValue"></select>
    <button class="btn-apply" onclick="applyMapping()">‚úì Apply Mapping</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<div class="header">
  <div class="header-left">
    <h1>Sales Analytics</h1>
    <p id="headerSub">Upload your Excel file to begin</p>
  </div>
  <div class="filters" id="vendorFilters" style="display:none"></div>
</div>

<!-- ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ -->
<div class="empty-state" id="emptyState">
  <div class="empty-arrow">‚Üë</div>
  <div class="empty-icon">üìã</div>
  <h2>No Data Loaded</h2>
  <p>Upload your ecommerce Excel or CSV file using the bar above. Charts and KPIs will render automatically.</p>
  <div class="hint-cols">
    Expected columns (auto-detected) ¬∑ Vendor ¬∑ Platform ¬∑ Month ¬∑ Product ¬∑ Qty ¬∑ MRP ¬∑ Value ¬∑ Returns ¬∑ Cancelled
  </div>
</div>

<!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
<div class="dashboard" id="dashboard" style="display:none">
  <div class="kpi-row" id="kpiRow"></div>
  <div class="charts-grid">
    <div class="card">
      <div class="card-title">Monthly Revenue Trend <span id="revenueSubtitle"></span></div>
      <div class="chart-container" style="height:220px"><canvas id="revenueChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Platform Split <span>by Revenue</span></div>
      <div class="chart-container" style="height:195px"><canvas id="platformChart"></canvas></div>
      <div class="legend-row" id="platformLegend"></div>
    </div>
  </div>
  <div class="charts-grid2">
    <div class="card">
      <div class="card-title">Units by Platform</div>
      <div id="platformBars"></div>
    </div>
    <div class="card">
      <div class="card-title">Product Performance <span>Units Sold</span></div>
      <div class="chart-container" style="height:220px"><canvas id="productChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Returns &amp; Cancellations</div>
      <div class="returns-grid" id="returnsGrid"></div>
      <div style="margin-top:16px">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px">By Platform</div>
        <div id="returnPlatformList"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Transaction Detail <span id="tableCount"></span></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Month</th><th>Vendor</th><th>Platform</th><th>Product</th>
            <th style="text-align:right">Qty</th>
            <th style="text-align:right">MRP</th>
            <th style="text-align:right">Revenue (‚Çπ)</th>
            <th style="text-align:right">Returns</th>
            <th style="text-align:right">Cancelled</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ALL_DATA = [];
let currentVendor = 'all';
let revenueChart, platformChart, productChart;
let rawRows = [], sheetHeaders = [];

const MONTH_ORDER = {
  january:0,february:1,march:2,april:3,may:4,june:5,
  july:6,august:7,september:8,october:9,november:10,december:11
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingFile = null;

function onDragOver(e) { e.preventDefault(); document.getElementById('fileDrop').classList.add('drag-over'); }
function onDragLeave()  { document.getElementById('fileDrop').classList.remove('drag-over'); }
function onDrop(e) {
  e.preventDefault();
  document.getElementById('fileDrop').classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f) setFile(f);
}
function onFileChange(e) { if (e.target.files[0]) setFile(e.target.files[0]); }

function setFile(file) {
  pendingFile = file;
  document.getElementById('fileLabel').textContent = 'üìÑ ' + file.name;
  document.getElementById('loadBtn').disabled = false;
  setStatus('loading','Ready ‚Äî click Load Data');
}

function processFile() {
  if (!pendingFile) return;
  setStatus('loading','‚è≥ Parsing file‚Ä¶');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array', cellDates:true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval: null });
      if (!json.length) { setStatus('err','‚ö† Sheet is empty'); return; }
      rawRows = json;
      sheetHeaders = Object.keys(json[0]);
      autoDetectAndLoad();
    } catch(err) { setStatus('err','‚ö† Parse error: '+err.message); }
  };
  reader.readAsArrayBuffer(pendingFile);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLUMN AUTO-DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIELD_HINTS = {
  vendor:          ['vendor','seller','company','brand owner'],
  platform:        ['platform','channel','marketplace','site','store'],
  month:           ['month','period','mon','month name'],
  product:         ['product name','product_name','sku','item name'],
  product_full:    ['product','item','name'],
  qty:             ['qty','quantity','units','unit sold','units sold','sales qty','sold'],
  mrp:             ['mrp','price','rate','sp','selling price','unit price','price per unit'],
  value:           ['value','revenue','amount','total','gmv','sales value','net revenue','net sales'],
  customer_return: ['customer return','cust return','customer_return','return qty','returns','customer rto'],
  courier_return:  ['courier return','courier_return','courier rto','rto'],
  cancelled:       ['cancelled','cancellation','cancel','cancelled qty'],
};

function findCol(headers, hints) {
  const lower = headers.map(h => h ? h.toString().toLowerCase().trim() : '');
  for (const hint of hints) {
    const i = lower.findIndex(h => h === hint || h.includes(hint));
    if (i > -1) return headers[i];
  }
  return null;
}

function autoDetectAndLoad() {
  const mapping = {};
  let missing = 0;
  for (const [field, hints] of Object.entries(FIELD_HINTS)) {
    mapping[field] = findCol(sheetHeaders, hints);
    if (!mapping[field] && ['vendor','platform','month','product','qty','value'].includes(field)) missing++;
  }
  if (missing === 0) {
    loadWithMapping(mapping);
    setStatus('ok','‚úì Loaded ' + rawRows.length + ' rows ‚Äî auto-detected columns');
  } else {
    populateMapper(mapping);
    setStatus('loading','‚ö† Couldn\'t auto-detect all columns. Please map them below ‚Üì');
  }
}

function populateMapper(mapping) {
  const fields = ['mapVendor','mapPlatform','mapMonth','mapProduct','mapQty','mapMrp','mapValue'];
  const keys   = ['vendor','platform','month','product','qty','mrp','value'];
  const opts   = ['(none)', ...sheetHeaders].map(h => `<option value="${h}">${h}</option>`).join('');
  fields.forEach((id, i) => {
    const el = document.getElementById(id);
    el.innerHTML = opts;
    if (mapping[keys[i]]) el.value = mapping[keys[i]];
  });
  document.getElementById('colMapRow').classList.add('visible');
}

function applyMapping() {
  const mapping = {
    vendor:   document.getElementById('mapVendor').value,
    platform: document.getElementById('mapPlatform').value,
    month:    document.getElementById('mapMonth').value,
    product:  document.getElementById('mapProduct').value,
    qty:      document.getElementById('mapQty').value,
    mrp:      document.getElementById('mapMrp').value,
    value:    document.getElementById('mapValue').value,
    customer_return: null, courier_return: null, cancelled: null,
  };
  document.getElementById('colMapRow').classList.remove('visible');
  loadWithMapping(mapping);
  setStatus('ok','‚úì Loaded ' + rawRows.length + ' rows with custom mapping');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD & NORMALIZE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadWithMapping(m) {
  const get = (row, col) => col && row[col] !== null && row[col] !== undefined ? row[col] : null;
  ALL_DATA = rawRows.map(row => {
    const qty   = parseFloat(get(row, m.qty))   || 0;
    const mrp   = parseFloat(get(row, m.mrp))   || 0;
    const value = parseFloat(get(row, m.value)) || (qty * mrp);
    const month = get(row, m.month);
    return {
      vendor:          (get(row, m.vendor)   || 'Unknown').toString().trim(),
      platform:        (get(row, m.platform) || 'Unknown').toString().trim(),
      month:           month ? month.toString().trim() : 'Unknown',
      product_name:    (get(row, m.product)  || 'Unknown').toString().trim(),
      product_full:    (get(row, m.product_full) || get(row, m.product) || 'Unknown').toString().trim(),
      mrp, qty, value,
      customer_return: parseFloat(get(row, m.customer_return)) || 0,
      courier_return:  parseFloat(get(row, m.courier_return))  || 0,
      cancelled:       parseFloat(get(row, m.cancelled))       || 0,
    };
  }).filter(d => d.qty > 0 || d.value > 0);

  currentVendor = 'all';
  buildVendorFilters();

  const months = sortedMonths(ALL_DATA);
  document.getElementById('headerSub').textContent =
    months.length ? months[0] + ' ¬∑ ¬∑ ¬∑ ' + months[months.length-1] : 'All time';

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('vendorFilters').style.display = 'flex';
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setStatus(type, msg) {
  document.getElementById('statusBadge').innerHTML = `<span class="upload-status status-${type}">${msg}</span>`;
}

function filtered() {
  return currentVendor === 'all' ? ALL_DATA : ALL_DATA.filter(d => d.vendor === currentVendor);
}

function fmt(n) {
  if (n >= 1e7) return '‚Çπ' + (n/1e7).toFixed(2) + 'Cr';
  if (n >= 1e5) return '‚Çπ' + (n/1e5).toFixed(1) + 'L';
  return '‚Çπ' + Math.round(n).toLocaleString('en-IN');
}
function fmtNum(n) {
  if (n >= 1e5) return (n/1e5).toFixed(1)+'L';
  if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toString();
}

function normPlatform(p) {
  const n = p.toLowerCase().trim();
  if (n.includes('amazon'))  return 'Amazon';
  if (n.includes('flipkart'))return 'Flipkart';
  if (n.includes('myntra'))  return 'Myntra';
  if (n.includes('meesho'))  return 'Meesho';
  if (n.includes('blinkit')) return 'Blinkit';
  if (n.includes('karissa')) return 'KarissaKart';
  return p;
}

const P_COLORS = {
  amazon:'#FF9900', flipkart:'#2874F0', myntra:'#FF3F6C',
  meesho:'#9C27B0', blinkit:'#d4e82b', karissaKart:'#7c6cfc',
};
const EXTRA_COLORS = ['#7c6cfc','#6cfcb8','#fcb86c','#fc6cc8','#6cc8fc','#fcfc6c','#fc9c6c','#9cfc6c'];
const colorCache = {};
let colorIdx = 0;

function platformColor(p) {
  const k = p.toLowerCase();
  for (const [name, col] of Object.entries(P_COLORS)) if (k.includes(name)) return col;
  if (!colorCache[p]) colorCache[p] = EXTRA_COLORS[colorIdx++ % EXTRA_COLORS.length];
  return colorCache[p];
}
function prodColor(p) {
  if (!colorCache['__prod_'+p]) colorCache['__prod_'+p] = EXTRA_COLORS[colorIdx++ % EXTRA_COLORS.length];
  return colorCache['__prod_'+p];
}

function sortedMonths(data) {
  const set = [...new Set(data.map(d => d.month))];
  return set.sort((a,b) => {
    const ai = MONTH_ORDER[a.toLowerCase()] ?? 99;
    const bi = MONTH_ORDER[b.toLowerCase()] ?? 99;
    return ai - bi;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VENDOR FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildVendorFilters() {
  const vendors = [...new Set(ALL_DATA.map(d=>d.vendor))].sort();
  const c = document.getElementById('vendorFilters');
  c.innerHTML = `<div style="color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:1px">Vendor:</div>
    <button class="filter-btn active" onclick="filterVendor('all',this)">All</button>
    ${vendors.map(v=>`<button class="filter-btn" onclick="filterVendor('${v}',this)">${v}</button>`).join('')}`;
}

function filterVendor(v, btn) {
  currentVendor = v;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  const data = filtered();
  updateKPIs(data);
  updateRevenueChart(data);
  updatePlatformChart(data);
  updatePlatformBars(data);
  updateProductChart(data);
  updateReturns(data);
  updateTable(data);
}

function updateKPIs(data) {
  const totalRev  = data.reduce((s,d)=>s+d.value,0);
  const totalQty  = data.reduce((s,d)=>s+d.qty,0);
  const totalCR   = data.reduce((s,d)=>s+d.customer_return,0);
  const totalCouR = data.reduce((s,d)=>s+d.courier_return,0);
  const totalCan  = data.reduce((s,d)=>s+d.cancelled,0);
  const platforms = new Set(data.map(d=>normPlatform(d.platform)));
  const products  = new Set(data.map(d=>d.product_name));
  const months    = sortedMonths(data);
  const byMonth   = {};
  data.forEach(d=>{ byMonth[d.month]=(byMonth[d.month]||0)+d.value; });
  const last = months[months.length-1], prev = months[months.length-2];
  const growth = prev && byMonth[prev] ? ((byMonth[last]-byMonth[prev])/byMonth[prev]*100).toFixed(1) : null;

  document.getElementById('kpiRow').innerHTML = `
    <div class="kpi" style="--kpi-color:var(--accent)">
      <div class="kpi-label">Total Revenue</div>
      <div class="kpi-value">${fmt(totalRev)}</div>
      <div class="kpi-sub">${growth?`<span class="kpi-badge ${growth>0?'badge-up':'badge-down'}">${growth>0?'‚ñ≤':'‚ñº'}${Math.abs(growth)}%</span> vs prev month`:'All periods'}</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--accent3)">
      <div class="kpi-label">Units Sold</div>
      <div class="kpi-value">${fmtNum(totalQty)}</div>
      <div class="kpi-sub">${months.length} months ¬∑ ${platforms.size} platforms</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--accent4)">
      <div class="kpi-label">Avg Rev / Unit</div>
      <div class="kpi-value">‚Çπ${Math.round(totalRev/(totalQty||1))}</div>
      <div class="kpi-sub">${products.size} product SKUs</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--accent2)">
      <div class="kpi-label">Returns</div>
      <div class="kpi-value">${totalCR+totalCouR}</div>
      <div class="kpi-sub">Cust: ${totalCR} ¬∑ Courier: ${totalCouR}</div>
    </div>
    <div class="kpi" style="--kpi-color:#666">
      <div class="kpi-label">Cancellations</div>
      <div class="kpi-value">${totalCan}</div>
      <div class="kpi-sub">${totalQty?((totalCan/totalQty)*100).toFixed(2)+'% cancel rate':''}</div>
    </div>`;
}

const chartBase = (extra={}) => ({
  responsive:true, maintainAspectRatio:false,
  plugins:{
    legend:{display:false},
    tooltip:{backgroundColor:'#181826',borderColor:'#252535',borderWidth:1,titleColor:'#888899',bodyColor:'#e8e8f0'}
  },
  ...extra
});

function updateRevenueChart(data) {
  const months = sortedMonths(data);
  const byM = {}; data.forEach(d=>{ byM[d.month]=(byM[d.month]||0)+d.value; });
  document.getElementById('revenueSubtitle').textContent = months[0]+' ‚Üí '+months[months.length-1];
  if (revenueChart) revenueChart.destroy();
  revenueChart = new Chart(document.getElementById('revenueChart'),{
    type:'line',
    data:{
      labels: months.map(m=>m.substring(0,3)),
      datasets:[{
        data: months.map(m=>byM[m]||0),
        borderColor:'#7c6cfc', backgroundColor:'rgba(124,108,252,0.08)',
        borderWidth:2.5, pointBackgroundColor:'#7c6cfc',
        pointRadius:4, pointHoverRadius:6, fill:true, tension:0.4
      }]
    },
    options:{
      ...chartBase(),
      plugins:{...chartBase().plugins,tooltip:{...chartBase().plugins.tooltip,
        callbacks:{label:ctx=>' ‚Çπ'+Math.round(ctx.parsed.y).toLocaleString('en-IN')}}},
      scales:{
        x:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#888899',font:{family:'DM Mono',size:11}}},
        y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#888899',font:{family:'DM Mono',size:10},
          callback:v=>v>=1e5?'‚Çπ'+(v/1e5).toFixed(0)+'L':'‚Çπ'+v}}
      }
    }
  });
}

function updatePlatformChart(data) {
  const byP={};
  data.forEach(d=>{ const p=normPlatform(d.platform); byP[p]=(byP[p]||0)+d.value; });
  const sorted=Object.entries(byP).sort((a,b)=>b[1]-a[1]);
  const colors=sorted.map(([p])=>platformColor(p));
  if (platformChart) platformChart.destroy();
  platformChart = new Chart(document.getElementById('platformChart'),{
    type:'doughnut',
    data:{labels:sorted.map(e=>e[0]),datasets:[{data:sorted.map(e=>e[1]),backgroundColor:colors,borderWidth:2,borderColor:'#111118',hoverOffset:6}]},
    options:{...chartBase(),cutout:'68%',plugins:{...chartBase().plugins,tooltip:{...chartBase().plugins.tooltip,
      callbacks:{label:ctx=>' '+ctx.label+': ‚Çπ'+Math.round(ctx.parsed).toLocaleString('en-IN')}}}}
  });
  const total=sorted.reduce((s,e)=>s+e[1],0);
  document.getElementById('platformLegend').innerHTML=sorted.map(([p,v],i)=>`
    <div class="legend-item"><span class="dot" style="background:${colors[i]}"></span>${p}<b style="color:var(--text);margin-left:4px">${(v/total*100).toFixed(1)}%</b></div>`).join('');
}

function updatePlatformBars(data) {
  const byP={};
  data.forEach(d=>{ const p=normPlatform(d.platform); byP[p]=(byP[p]||0)+d.qty; });
  const sorted=Object.entries(byP).sort((a,b)=>b[1]-a[1]);
  const max=sorted[0]?.[1]||1;
  document.getElementById('platformBars').innerHTML=sorted.map(([p,v])=>{
    const c=platformColor(p);
    return `<div class="platform-row">
      <div class="platform-name"><span class="dot" style="background:${c}"></span>${p}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(v/max*100).toFixed(1)}%;background:${c}"></div></div>
      <div class="platform-val">${v.toLocaleString()}</div>
    </div>`;
  }).join('');
}

function updateProductChart(data) {
  const byP={};
  data.forEach(d=>{ const key=d.product_name||d.product_full; byP[key]=(byP[key]||0)+d.qty; });
  const sorted=Object.entries(byP).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const colors=sorted.map(([p])=>prodColor(p));
  if (productChart) productChart.destroy();
  productChart = new Chart(document.getElementById('productChart'),{
    type:'bar',
    data:{labels:sorted.map(e=>e[0]),datasets:[{data:sorted.map(e=>e[1]),backgroundColor:colors,borderRadius:5,borderSkipped:false}]},
    options:{
      ...chartBase(),indexAxis:'y',
      plugins:{...chartBase().plugins,tooltip:{...chartBase().plugins.tooltip,
        callbacks:{label:ctx=>' '+ctx.parsed.x.toLocaleString()+' units'}}},
      scales:{
        x:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#888899',font:{family:'DM Mono',size:10}}},
        y:{grid:{display:false},ticks:{color:'#e8e8f0',font:{family:'DM Mono',size:11}}}
      }
    }
  });
}

function updateReturns(data) {
  const cr=data.reduce((s,d)=>s+d.customer_return,0);
  const co=data.reduce((s,d)=>s+d.courier_return,0);
  const ca=data.reduce((s,d)=>s+d.cancelled,0);
  document.getElementById('returnsGrid').innerHTML=`
    <div class="return-stat"><div class="val" style="color:var(--accent2)">${cr}</div><div class="lbl">Customer</div></div>
    <div class="return-stat"><div class="val" style="color:var(--accent4)">${co}</div><div class="lbl">Courier</div></div>
    <div class="return-stat"><div class="val" style="color:var(--muted)">${ca}</div><div class="lbl">Cancelled</div></div>`;
  const byP={};
  data.forEach(d=>{ const p=normPlatform(d.platform); if(!byP[p])byP[p]={cr:0,co:0,ca:0}; byP[p].cr+=d.customer_return; byP[p].co+=d.courier_return; byP[p].ca+=d.cancelled; });
  const sorted=Object.entries(byP).filter(([,v])=>v.cr+v.co+v.ca>0).sort((a,b)=>(b[1].cr+b[1].co+b[1].ca)-(a[1].cr+a[1].co+a[1].ca));
  document.getElementById('returnPlatformList').innerHTML=sorted.length
    ?sorted.map(([p,v])=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px"><span>${p}</span><span style="color:var(--muted)">Cust:${v.cr} Courier:${v.co} Cancel:${v.ca}</span></div>`).join('')
    :'<div style="color:var(--muted);font-size:12px;padding:10px 0">No return/cancellation data in this dataset</div>';
}

function updateTable(data) {
  const months=sortedMonths(data);
  const sorted=[...data].sort((a,b)=>months.indexOf(a.month)-months.indexOf(b.month));
  document.getElementById('tableCount').textContent=sorted.length+' rows';
  document.getElementById('tableBody').innerHTML=sorted.map(d=>{
    const p=normPlatform(d.platform), c=platformColor(p), pc=prodColor(d.product_name);
    const totalRet=d.customer_return+d.courier_return;
    return `<tr>
      <td>${d.month}</td>
      <td style="color:var(--muted)">${d.vendor}</td>
      <td><span class="dot" style="background:${c}"></span>${p}</td>
      <td><span class="dot" style="background:${pc}"></span>${d.product_name}</td>
      <td style="text-align:right">${d.qty.toLocaleString()}</td>
      <td style="text-align:right">${d.mrp?'‚Çπ'+d.mrp:'‚Äî'}</td>
      <td style="text-align:right;font-weight:600">‚Çπ${Math.round(d.value).toLocaleString('en-IN')}</td>
      <td style="text-align:right;color:${totalRet>0?'var(--accent2)':'var(--muted)'}">${totalRet||'‚Äî'}</td>
      <td style="text-align:right;color:${d.cancelled>0?'var(--accent4)':'var(--muted)'}">${d.cancelled||'‚Äî'}</td>
    </tr>`;
  }).join('');
}
</script>
</body>
</html>